name: iOS CI

on:
  push: { branches: ['**'] }
  pull_request: { branches: ['**'] }

jobs:
  build-test:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode_15.4.app || sudo xcode-select -s /Applications/Xcode.app
          xcodebuild -version

      - name: Locate Xcode project & shared scheme
        run: |
          set -euo pipefail
          PROJ="$(find . -maxdepth 2 -type d -name '*.xcodeproj' | head -n1 || true)"
          if [ -z "$PROJ" ]; then
            echo "::error::No .xcodeproj found. Tree:"; find . -maxdepth 3 -print; exit 1
          fi
          echo "PROJECT: $PROJ"

          SCHEME="$(ls -1 "$PROJ"/xcshareddata/xcschemes/*.xcscheme 2>/dev/null | sed 's#.*/##; s#.xcscheme$##' | head -n1 || true)"
          if [ -z "$SCHEME" ]; then
            echo "::group::Schemes (not shared yet?)"
            xcodebuild -list -project "$PROJ" || true
            echo "::endgroup::"
            echo "::error::No shared scheme found. En Xcode: Product > Scheme > Manage Schemes… > tilda 'Shared' y commitea *.xcscheme"
            exit 1
          fi

          echo "SCHEME=$SCHEME" >> $GITHUB_ENV
          echo "PROJ=$PROJ" >> $GITHUB_ENV
          echo "Using scheme: $SCHEME"

      - name: Build & Test (SwiftLint plugin corre durante el build si está agregado)
        run: |
          set -o pipefail
          xcodebuild \
            -project "$PROJ" \
            -scheme "$SCHEME" \
            -destination 'platform=iOS Simulator,OS=latest,name=iPhone 15' \
            -skipPackagePluginValidation -skipMacroValidation \
            clean test | tee xcodebuild.log
